{
  "$id": "https://www.krakend.io/schema/v3.json",
  "version": 3,
  "name": "Keyfairy API Gateway",
  "port": $PORT,
  "timeout": "60s",
  "extra_config": {
    "router": { "return_error_msg": true },
    "backend/http/client": {
      "idle_connection_timeout": "600s",
      "response_header_timeout": "30s",
      "expect_continue_timeout": "3s",
      "dialer_timeout": "30s",
      "dialer_keep_alive": "60s",
      "max_idle_connections": 500,
      "max_idle_connections_per_host": 50,
      "disable_keep_alives": false
    }
  },
  "endpoints": [
    {
      "endpoint": "/users",
      "method": "POST",
      "timeout": "45s",
      "output_encoding": "no-op",
      "backend": [
        {
          "host": ["http://auth-service:8000"],
          "url_pattern": "/api/v1/users/",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/users",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://auth-service:8000"],
          "url_pattern": "/api/v1/users",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/users/{uid}",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://auth-service:8000"],
          "url_pattern": "/api/v1/users/{uid}",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/users/{uid}",
      "method": "PUT",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://auth-service:8000"],
          "url_pattern": "/api/v1/users/{uid}",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/auth/register",
      "method": "POST",
      "timeout": "45s",
      "output_encoding": "no-op",
      "backend": [
        {
          "host": ["http://auth-service:8000"],
          "url_pattern": "/api/v1/auth/register",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/auth/login",
      "method": "POST",
      "timeout": "45s",
      "output_encoding": "no-op",
      "backend": [
        {
          "host": ["http://auth-service:8000"],
          "url_pattern": "/api/v1/auth/login",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/auth/refresh-token",
      "method": "POST",
      "timeout": "45s",
      "output_encoding": "no-op",
      "backend": [
        {
          "host": ["http://auth-service:8000"],
          "url_pattern": "/api/v1/auth/refresh-token",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/practice/register",
      "method": "POST",
      "timeout": "120s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://receive-service:8110"],
          "url_pattern": "/practice/register",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/practice/{uid}",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://practice-service:8130"],
          "url_pattern": "/practice/{uid}",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ],
      "input_query_strings":["last_id", "limit"]
    },
    {
      "endpoint": "/practice/{uid}/{practice_id}",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://practice-service:8130"],
          "url_pattern": "/practice/{uid}/{practice_id}",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/reports/{uid}/{practice_id}",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://practice-service:8130"],
          "url_pattern": "/reports/{uid}/{practice_id}",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/postural-errors/{practice_id}",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://practice-service:8130"],
          "url_pattern": "/postural-errors/{practice_id}",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/musical-errors/{practice_id}",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://practice-service:8130"],
          "url_pattern": "/musical-errors/{practice_id}",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ]
    },
    {
      "endpoint": "/analytics/top-escalas-semanales",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://analytics-service:8120"],
          "url_pattern": "/analytics/top-escalas-semanales",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ],
      "input_query_strings": ["idStudent", "anio", "semana"]
    },
    {
      "endpoint": "/analytics/tiempo-posturas-semanales",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://analytics-service:8120"],
          "url_pattern": "/analytics/tiempo-posturas-semanales",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ],
      "input_query_strings": ["idStudent", "anio", "semana"]
    },
    {
      "endpoint": "/analytics/notas-resumen-semanales",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://analytics-service:8120"],
          "url_pattern": "/analytics/notas-resumen-semanales",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ],
      "input_query_strings": ["idStudent", "anio", "semana"]
    },
    {
      "endpoint": "/analytics/errores-posturales-semanales",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://analytics-service:8120"],
          "url_pattern": "/analytics/errores-posturales-semanales",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ],
      "input_query_strings": ["idStudent", "anio", "semana"]
    },
    {
      "endpoint": "/analytics/errores-musicales-semanales",
      "method": "GET",
      "timeout": "45s",
      "output_encoding": "no-op",
      "extra_config": {
        "auth/validator": {
          "alg": "RS256",
          "jwk_url": "$FIREBASE_JWK_URL",
          "audience": ["$FIREBASE_PROJECT_ID"],
          "issuer": "$FIREBASE_ISSUER",
          "cache": true,
          "cache_duration": 15
        }
      },
      "backend": [
        {
          "host": ["http://analytics-service:8120"],
          "url_pattern": "/analytics/errores-musicales-semanales",
          "encoding": "no-op",
          "timeout": "40s"
        }
      ],
      "input_query_strings": ["idStudent", "anio", "semana"]
    }
  ]
}